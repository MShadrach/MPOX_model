---
title: "Simulating MPOX disease SIR dynamics"
author: "Shadrach Mintah, Benjamin Tommy Bavug, Kama Mary Ofuru, Victoria Nakalanzi"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

In this walk through, we will be simulating an SIR model.

The SIR model is a simple compartmental model used to describe the spread of MPOX, which is an infectious disease in a population. The model divides the population into three compartments: susceptible (S), infectious (I), and recovered (R) individuals. The model equations describe the flow of individuals between these compartments based on the transmission rate ($\beta$) and the recovery rate ($\gamma$).



## The model function

We have the following $assumptions$:

- The is natural immunity after recovery
- There is homogeneity of the population
- There is a constant removal rate due to other causes (1/10)
- Transmission is between human to huma contact



We start by defining the model equations.

The SIR model equations is given by:

\begin{align}
\frac{dS}{dt} & = \color{orange}{\frac{-\beta S I}{N}} \\
\frac{dI}{dt} & = \color{orange}{\frac{\beta S I}{N}} - \color{blue}{\gamma I} \\
\frac{dR}{dt} & = \color{blue}{\frac{\gamma I}{N}}
\end{align}

where:

- $N$ is the population
- $\frac{dS}{dt}$ is the change in number of $Susceptible$ over time,
- $\frac{dI}{dt}$ is the change in number of $Infected$ over time,
- $\frac{dR}{dt}$ is the change in number of $Recovered$ over time,
- $\beta$ is the transmission rate,
- $\gamma$ is the recovered rate.


but
\begin{align}
\beta_1 = (b1 + b2) ---(1) \\
\beta_2 = b3 ------(2) 
\end{align}

- $b1$ is the transmission by direct contact
- $b2$ is the transmission by airborne
- $b3$ is the transmission by sexual contact

- $\beta_1$ is the transmission rate via direct contact/airbone
- $\beta_2$ is the transmission rate via sexual contact



which translates into:

Transmission from children

\begin{align}
\frac{dS_c}{dt} & = \color{orange}{-\beta_1 S_c I_c} \\
\frac{dI_c}{dt} & = \color{orange}{\beta_1 S_c I_c} - \color{blue}{\gamma I_c} \\
\frac{dR_c}{dt} & = \color{blue}{\gamma I_c}
\end{align}

and 

Transmission from adults

\begin{align}
\frac{dS_a}{dt} & = \color{orange}{-\beta_1 S_a I_a} \\
\frac{dS_a}{dt} & = \color{orange}{-\beta_2 S_a I_a} \\

\frac{dI_a}{dt} & = \color{orange}{\beta_1 S_a I_a} - \color{blue}{\gamma I_a} \\
\frac{dI_a}{dt} & = \color{orange}{\beta_2 S_a I_a} - \color{blue}{\gamma I_a} \\

\frac{dR_a}{dt} & = \color{blue}{\gamma I_a}
\end{align}


where:

- $S_a$ is the number of susceptible individuals(adults),
- $I_a$ is the number of infectious individuals (adults),
- $R_a$ is the number of removal individuals(adults),
- $S_c$ is the number of susceptible individuals(children),
- $I_c$ is the number of infectious individuals (children),
- $R_c$ is the number of removal individuals(children)



## Model for children below 18yrs

```{r below_18yrs}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)


sir_model_u <- function(t, y, parms) {
  with(as.list(c(y, parms)), {
    dS <- -(beta) * S * I
    dI <- (beta) * S * I - gamma * I
    dR <- gamma * I
    return(list(c(dS, dI, dR)))
  })
}


# 2. Define the parameter 

# Using Nigeria
N  <- 220000000
N1 <- 95000000 # 45% of 220million are under 18years (Nigeria)
N2 <- 125000000 # 55% of 220million are above 18years (Nigeria)

I0 <- 20

# Initial conditions for S, I, R
inits <- c(S = N - I0, I = I0, R = 0)

R0 <- 1.8

# The infectious period is the average duration for which an individual remains infectious.
infectious_period <- 14
# Remember gamma = 1/ infectious_period as discussed in the slides
gamma <- 1/infectious_period 

# The define beta, we will use the relation R0 = beta / gamma  because it is easier to interpret, that is, given an R0 and infectious period, we can calculate the corresponding beta value.
# beta is not directly interpretable because it is a composite of a number of factors.
beta <- R0 * gamma/N

beta1 <- R0 * gamma/N #transmission rate for  direct and airborne contact
# beta2 <- R0 * gamma/N2 #transmission rate for sexual contact




#beta_a = beta1 + beta2

# beta_a=0.7
# bata=0.5
# The parameters
params <- c(
  beta = beta,
  gamma = gamma
)

#3. Define the initial conditions


# Initial conditions for S, I, R

# 4. Define the time points to return results
dt <- 1:365

#5. Solve the model
# Load the necessary libraries
library(deSolve)
# Solve the model
results <- deSolve::lsoda(
  y = inits,
  times = dt,
  func = sir_model_u,
  parms = params
)

#6. Manipulate and interpret the results
# Make it a data.frame
results <- as.data.frame(results)
head(results)
tail(results)

### Plotting the results

# Load the necessary libraries
library(ggplot2)
library(tidyr)
# Create data for ggplot2 by reshaping
results_long <- results |>
  pivot_longer(
    cols = c(2:4),
    names_to = "compartment",
    values_to = "value"
  )

sir_plot1 <- ggplot(
  data = results_long,
  aes(
    x = time,
    y = value,
    color = compartment
  )
  ) +
  geom_line(linewidth = 1) +
  labs(
    title = "SIR model of MPOX (infection from people below 18years)",
    x = "Time",
    y = "Number of individuals"
  )
plot(sir_plot1)
```

```{r}
# Define the SIR model for children
sir_model_children <- function(t, y, parms) {
  with(as.list(c(y, parms)), {
    dS_c <- -beta_c * S_c * I_c
    dI_c <- beta_c * S_c * I_c - gamma * I_c
    dR_c <- gamma * I_c
    return(list(c(dS_c, dI_c, dR_c)))
  })
}

# Population and parameters for children
N_c <- 95000000  # Number of children under 18 years (45% of total population in Nigeria)
I0_c <- 20       # Initial number of infected children
S0_c <- N_c - I0_c  # Initial number of susceptible children

# Define R0, infectious period, and gamma
R0_c <- 1.8
infectious_period_c <- 14
gamma_c <- 1 / infectious_period_c  # Recovery rate for children

# Calculate beta using the formula: R0 = beta / gamma
beta_c <- R0_c * gamma_c / N_c  # Transmission rate for children

# Parameters for the children's model
params_c <- c(beta_c = beta_c, gamma = gamma_c)

# Initial conditions for children
inits_c <- c(S_c = S0_c, I_c = I0_c, R_c = 0)

# Time points
time_c <- 1:365

# Solve the model for children
results_children <- deSolve::lsoda(y = inits_c, times = time_c, func = sir_model_children, parms = params_c)

# Convert the results to a data frame
results_children <- as.data.frame(results_children)
head(results_children)

# Plotting the results for children
results_long_children <- results_children |> 
  pivot_longer(cols = c(S_c, I_c, R_c), names_to = "compartment", values_to = "value")

ggplot(results_long_children, aes(x = time, y = value, color = compartment)) +
  geom_line(linewidth = 1) +
  labs(title = "SIR Model for Children (Under 18 years)", x = "Time", y = "Population Size")

```


## Model for adults above 18yrs
```{r above_18yrs}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

# 1. Define the SIR model
sir_model <- function(t, y, parms) {
  with(as.list(c(y, parms)), {
    dS <- -beta_a * S * I
    dI <- beta_a * S * I - gamma * I
    dR <- gamma * I
    return(list(c(dS, dI, dR)))
  })
}

# 2. Define the parameter 
R0 <- 1.8

##############
# Using Nigeria
N  <- 220000000
N1 <- 95000000 # 45% of 220million are under 18years (Nigeria)
N2 <- 125000000 # 55% of 220million are above 18years (Nigeria)

I0 <- 20

# Initial conditions for S, I, R
inits <- c(S = N2 - I0, I = I0, R = 0)

R0 <- 1.8

# The infectious period is the average duration for which an individual remains infectious.
infectious_period <- 14
# Remember gamma = 1/ infectious_period as discussed in the slides
gamma <- 1/infectious_period 

# The define beta, we will use the relation R0 = beta / gamma  because it is easier to interpret, that is, given an R0 and infectious period, we can calculate the corresponding beta value.
# beta is not directly interpretable because it is a composite of a number of factors.

beta1 <- R0 * gamma/N #transmission rate for  direct and airborne contact
beta2 <- R0 * gamma/N2 #transmission rate for sexual contact

beta_a <- beta1 + beta2


# The infectious period is the average duration for which an individual remains infectious.
infectious_period <- 14
# Remember gamma = 1/ infectious_period as discussed in the slides
gamma <- 1/infectious_period 



# The parameters
params <- c(
  beta = beta_a,
  gamma = gamma
)


# Initial conditions for S, I, R

# 4. Define the time points to return results
dt <- 1:365

#5. Solve the model
# Load the necessary libraries
library(deSolve)
# Solve the model
results <- deSolve::lsoda(
  y = inits,
  times = dt,
  func = sir_model,
  parms = params
)

#6. Manipulate and interpret the results
# Make it a data.frame
results <- as.data.frame(results)
head(results)
tail(results)

### Plotting the results

# Load the necessary libraries
library(ggplot2)
library(tidyr)
# Create data for ggplot2 by reshaping
results_long <- results |>
  pivot_longer(
    cols = c(2:4),
    names_to = "compartment",
    values_to = "value"
  )

sir_plot1 <- ggplot(
  data = results_long,
  aes(
    x = time,
    y = value,
    color = compartment
  )
  ) +
  geom_line(linewidth = 1) +
  labs(
    title = "SIR model of MPOX (non-children above 18yrs)",
    x = "Time",
    y = "Number of individuals"
  )
plot(sir_plot1)
```
```{r}
# Define the SIR model for adults
sir_model_adults <- function(t, y, parms) {
  with(as.list(c(y, parms)), {
    dS_a <- -beta_a * S_a * I_a
    dI_a <- beta_a * S_a * I_a - gamma * I_a
    dR_a <- gamma * I_a
    return(list(c(dS_a, dI_a, dR_a)))
  })
}

# Population and parameters for adults
N_a <- 125000000  # Number of adults above 18 years (55% of total population in Nigeria)
I0_a <- 20        # Initial number of infected adults
S0_a <- N_a - I0_a  # Initial number of susceptible adults

# Define R0, infectious period, and gamma for adults
R0_a <- 1.8
infectious_period_a <- 14
gamma_a <- 1 / infectious_period_a  # Recovery rate for adults

# Calculate beta using the formula: R0 = beta / gamma
beta_a <- R0_a * gamma_a / N_a  # Transmission rate for adults

# Parameters for the adult model
params_a <- c(beta_a = beta_a, gamma = gamma_a)

# Initial conditions for adults
inits_a <- c(S_a = S0_a, I_a = I0_a, R_a = 0)

# Time points
time_a <- 1:365

# Solve the model for adults
results_adults <- deSolve::lsoda(y = inits_a, times = time_a, func = sir_model_adults, parms = params_a)

# Convert the results to a data frame
results_adults <- as.data.frame(results_adults)
head(results_adults)

# Plotting the results for adults
results_long_adults <- results_adults |> 
  pivot_longer(cols = c(S_a, I_a, R_a), names_to = "compartment", values_to = "value")

ggplot(results_long_adults, aes(x = time, y = value, color = compartment)) +
  geom_line(linewidth = 1) +
  labs(title = "SIR Model for Adults (Above 18 years)", x = "Time", y = "Population Size")

```



```{r contact_mixing_model}
knitr::opts_chunk$set(
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)

# Define the new SIR model with contact mixing between adults and children
sir_model_mixed <- function(t, y, parms) {
  with(as.list(c(y, parms)), {
    # For children
    dS_c <- -(beta_cc * S_c * I_c + beta_ac * S_c * I_a)
    dI_c <- (beta_cc * S_c * I_c + beta_ac * S_c * I_a) - gamma * I_c
    dR_c <- gamma * I_c
    
    # For adults
    dS_a <- -(beta_aa * S_a * I_a + beta_ca * S_a * I_c)
    dI_a <- (beta_aa * S_a * I_a + beta_ca * S_a * I_c) - gamma * I_a
    dR_a <- gamma * I_a
    
    return(list(c(dS_c, dI_c, dR_c, dS_a, dI_a, dR_a)))
  })
}

# Population size and parameters
N_c <- 95000000   # Number of children under 18 years
N_a <- 125000000  # Number of adults above 18 years
I0_c <- 10        # Initial infected in children
I0_a <- 10        # Initial infected in adults

# Initial conditions for both groups
inits_mixed <- c(S_c = N_c - I0_c, I_c = I0_c, R_c = 0, S_a = N_a - I0_a, I_a = I0_a, R_a = 0)

R0 <- 1.8
infectious_period <- 14
gamma <- 1 / infectious_period

# Transmission rates
beta_cc <- R0 * gamma / N_c  # Child to child
beta_aa <- R0 * gamma / N_a  # Adult to adult
beta_ca <- R0 * gamma / N_a  # Child to adult
beta_ac <- R0 * gamma / N_c  # Adult to child

# Parameters for the mixed model
params_mixed <- c(
  beta_cc = beta_cc,
  beta_aa = beta_aa,
  beta_ca = beta_ca,
  beta_ac = beta_ac,
  gamma = gamma
)

# Time points
dt <- 1:365

# Solve the model
library(deSolve)
results_mixed <- deSolve::lsoda(
  y = inits_mixed,
  times = dt,
  func = sir_model_mixed,
  parms = params_mixed
)

# Manipulate and interpret the results
results_mixed <- as.data.frame(results_mixed)
head(results_mixed)
tail(results_mixed)

# Plot the results
library(ggplot2)
library(tidyr)

# Reshape the data for plotting
results_long_mixed <- results_mixed |>
  pivot_longer(
    cols = c(2:7),
    names_to = "compartment",
    values_to = "value"
  )

sir_plot_mixed <- ggplot(
  data = results_long_mixed,
  aes(
    x = time,
    y = value,
    color = compartment
  )
  ) +
  geom_line(linewidth = 1) +
  labs(
    title = "SIR model with contact mixing between children and adults",
    x = "Time",
    y = "Number of individuals"
  )
plot(sir_plot_mixed)

```
## Explanation:

SIR Compartments: We have separate compartments for children (S_c, I_c, R_c) and adults (S_a, I_a, R_a).

Contact Mixing: The model allows transmission both within the same group (children-to-children and adults-to-adults) and between groups (children-to-adults and adults-to-children).

Transmission Parameters:
beta_cc: Transmission rate for children infecting other children.
beta_aa: Transmission rate for adults infecting other adults.
beta_ac: Transmission rate for adults infecting children.
beta_ca: Transmission rate for children infecting adults.

Initial Conditions: The model starts with a small number of infected individuals in both groups.

Plot: The plot show the progression of the disease in both children and adults over time.

